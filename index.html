<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Klaro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script>
        // Configuration de Tailwind pour le mode sombre bas√© sur une classe
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Appliquer une police plus moderne et lisible */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Am√©liorations de l'UI et animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-in-up { animation: slideInUp 0.4s ease-out forwards; }

        /* Styles pour le toast de notification */
        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        .animate-toast { animation: fadeinout 4s forwards; }
        
        /* Style pour l'√©diteur de texte riche */
        [contenteditable]:focus {
            outline: none;
        }

    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Conteneur principal de l'application -->
    <div id="app-container" class="flex flex-col h-screen">

        <!-- En-t√™te fixe -->
        <header class="bg-gray-800 dark:bg-gray-950 text-white shadow-md z-20">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-extrabold">Klaro</h1>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden md:block">
                        <span id="userEmailDisplay" class="text-sm text-gray-300 block">Non connect√©</span>
                        <span id="userNicknameDisplay" class="text-xs text-gray-500 font-bold"></span>
                    </div>
                    <button id="authBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Connexion</button>
                    <button id="adminBtn" class="hidden p-2 rounded-full hover:bg-white/20 transition-colors" title="Administration">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </button>
                    <button id="preferencesBtn" class="hidden p-2 rounded-full hover:bg-white/20 transition-colors" title="Pr√©f√©rences">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <button id="signOutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">D√©connexion</button>
                </div>
            </div>
            <div id="modeSelector" class="bg-gray-700 dark:bg-gray-800 flex justify-center gap-2 p-2 hidden">
                <button data-mode="pro" class="px-5 py-2 text-base font-bold rounded-lg transition-all duration-200">üè¢ Pro</button>
                <button data-mode="perso" class="px-5 py-2 text-base font-bold rounded-lg transition-all duration-200">üè† Perso</button>
            </div>
            <nav id="main-nav" class="bg-white/10 flex flex-wrap justify-center p-1 hidden">
                <!-- Les boutons de navigation seront ins√©r√©s ici par JS -->
            </nav>
        </header>

        <!-- Contenu principal scrollable -->
        <main class="flex-grow overflow-y-auto p-4 md:p-6">
            <div id="page-content" class="container mx-auto">
                <!-- Le contenu de la page sera inject√© ici -->
            </div>
        </main>
    </div>

    <!-- Modale (conteneur universel) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4 hidden animate-fade-in">
        <div id="modal-container" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-h-[90vh] flex flex-col animate-slide-in-up">
            <!-- Le contenu de la modale sera inject√© ici -->
        </div>
    </div>

    <!-- Template pour une page -->
    <template id="page-template">
        <div class="animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="page-title text-3xl font-bold text-gray-900 dark:text-gray-100"></h2>
                    <p class="page-description text-gray-600 dark:text-gray-400 mt-1"></p>
                </div>
                <button class="add-new-item-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg cursor-pointer text-lg w-full md:w-auto whitespace-nowrap shadow-md transition-transform hover:scale-105">‚ûï Ajouter</button>
            </div>
            <input type="text" class="searchBar w-full p-3 mb-6 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" placeholder="Rechercher...">
            <div class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </template>

    <!-- Template pour une carte -->
    <template id="card-template">
        <div class="card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg cursor-pointer transition-all duration-300 relative flex flex-col border border-gray-200 dark:border-gray-700 hover:-translate-y-1 hover:shadow-xl dark:hover:shadow-blue-500/20">
            <span class="card-icon absolute top-4 right-4 text-2xl opacity-40"></span>
            <div class="flex-grow flex flex-col">
                <h3 class="card-title text-xl font-bold text-gray-800 dark:text-gray-100 mb-2 break-words pr-8"></h3>
                <div class="card-summary text-gray-600 dark:text-gray-400 text-sm flex-grow"></div>
                <div class="card-footer mt-auto pt-3 text-sm flex justify-between items-center">
                    <div class="tags-display flex flex-wrap gap-2"></div>
                    <span class="owner-display text-xs text-gray-500 dark:text-gray-400 font-medium"></span>
                </div>
            </div>
        </div>
    </template>

<script type="module">
    // Importe les modules Firebase n√©cessaires.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, addDoc, writeBatch, where, arrayUnion, runTransaction, collectionGroup, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    // [NOUVEAU] Importation pour App Check
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

    // --- CONFIGURATION & CONSTANTES ---
    const firebaseConfig = {
        apiKey: "AIzaSyCFMC73NLlmTzGVGcK_-zTwwNyw6-jmr7Y",
        authDomain: "suivitravailapp.firebaseapp.com",
        projectId: "suivitravailapp",
        storageBucket: "suivitravailapp.appspot.com",
        messagingSenderId: "621525076182",
        appId: "1:621525076182:web:f5a9bc1f5aaae71ce7e177",
        measurementId: "G-15HMDGYYCN"
    };
    const appId = firebaseConfig.appId;
    const ADMIN_EMAIL = "chongaster@gmail.com";

    const COLLECTIONS = {
        OBJECTIFS: 'objectifs',
        ACTIONS: 'actions',
        NOTES_REUNION: 'notesReunion',
        TODO: 'todo_perso',
        VOYAGES: 'voyages',
        NOTES_PERSO: 'notes_perso',
        COURSES: 'courses',
        WALLET: 'wallet',
        USER_PREFERENCES: 'user_preferences',
        COLLABORATIVE_DOCS: 'collaborative_docs',
        NICKNAMES: 'nicknames'
    };

    const SHAREABLE_TYPES = [
        COLLECTIONS.NOTES_PERSO,
        COLLECTIONS.COURSES,
        COLLECTIONS.OBJECTIFS,
        COLLECTIONS.NOTES_REUNION,
        COLLECTIONS.VOYAGES,
        COLLECTIONS.ACTIONS,
        COLLECTIONS.TODO
    ];

    const NAV_CONFIG = {
        pro: [
            { id: 'objectifs', title: 'Objectifs', icon: 'üéØ', type: COLLECTIONS.OBJECTIFS, description: 'Suivez vos objectifs principaux.' },
            { id: 'actions', title: 'TO DO', icon: 'üìù', type: COLLECTIONS.ACTIONS, description: 'G√©rez vos t√¢ches professionnelles.' },
            { id: 'actionsTerminees', title: 'Termin√©es', icon: '‚úÖ', type: COLLECTIONS.ACTIONS, description: 'Consultez vos actions achev√©es.' },
            { id: 'notesReunion', title: 'Notes', icon: 'üìã', type: COLLECTIONS.NOTES_REUNION, description: 'Archivez vos notes de r√©union.' },
            { id: 'sharedWithMePro', title: 'Partag√©s', icon: 'ü§ù', type: COLLECTIONS.COLLABORATIVE_DOCS, description: 'Documents partag√©s avec vous.' }
        ],
        perso: [
            { id: 'todo_perso', title: 'TODO', icon: 'üìå', type: COLLECTIONS.TODO, description: 'Vos t√¢ches personnelles.' },
            { id: 'todo_perso_terminees', title: 'Termin√©es', icon: '‚úÖ', type: COLLECTIONS.TODO, description: 'Consultez vos t√¢ches personnelles achev√©es.' },
            { id: 'voyages', title: 'Voyages', icon: '‚úàÔ∏è', type: COLLECTIONS.VOYAGES, description: 'Planifiez vos prochaines escapades.' },
            { id: 'notes_perso', title: 'Notes', icon: 'üóíÔ∏è', type: COLLECTIONS.NOTES_PERSO, description: 'Vos pens√©es et m√©mos personnels.' },
            { id: 'courses', title: 'Courses', icon: 'üõí', type: COLLECTIONS.COURSES, description: 'N\'oubliez plus rien au supermarch√©.' },
            { id: 'wallet', title: 'Portefeuille', icon: 'üéüÔ∏è', type: COLLECTIONS.WALLET, description: 'Conservez vos billets et documents importants.' },
            { id: 'sharedWithMePerso', title: 'Partag√©s', icon: 'ü§ù', type: COLLECTIONS.COLLABORATIVE_DOCS, description: 'Documents partag√©s avec vous.' }
        ]
    };

    // --- INITIALISATION FIREBASE ---
    let app, db, auth, functions, storage;
    try {
        app = initializeApp(firebaseConfig);

        // [NOUVEAU] Initialisation de Firebase App Check
        // Remplacez 'YOUR_RECAPTCHA_V3_SITE_KEY' par votre propre cl√© de site reCAPTCHA v3.
        // Suivez les √©tapes dans la conversation pour obtenir cette cl√©.
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('YOUR_RECAPTCHA_V3_SITE_KEY'),
            isTokenAutoRefreshEnabled: true // Recommand√©
        });

        db = getFirestore(app);
        auth = getAuth(app);
        functions = getFunctions(app);
        storage = getStorage(app);
    } catch (e) {
        console.error("Erreur d'initialisation de Firebase:", e);
        document.body.innerHTML = `<div class="p-8 text-center text-red-500">Erreur critique de configuration Firebase. L'application ne peut pas d√©marrer.</div>`;
    }
    
    const googleProvider = new GoogleAuthProvider();

    // --- VARIABLES GLOBALES & S√âLECTEURS DOM ---
    let userId = null;
    let userPreferences = { theme: 'light', startupMode: 'perso', nickname: '' };
    let currentMode = userPreferences.startupMode;
    let currentPageId = NAV_CONFIG[currentMode][0].id;
    let unsubscribeListeners = [];
    let allDataCache = {};
    let nicknameCache = {};

    const modalOverlay = document.getElementById('modal-overlay');
    const modalContainer = document.getElementById('modal-container');
    const pageContent = document.getElementById('page-content');
    const mainNav = document.getElementById('main-nav');
    const modeSelector = document.getElementById('modeSelector');

    // --- FONCTIONS UTILITAIRES & MODALES ---
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-5 right-5 text-white px-5 py-3 rounded-lg shadow-xl z-50 animate-toast text-base flex items-center gap-2';
        const icons = { success: '‚úîÔ∏è', error: '‚ùå', info: '‚ÑπÔ∏è' };
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
        
        toast.classList.add(colors[type] || colors.info);
        toast.innerHTML = `${icons[type] || icons.info} ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function showModal(content, maxWidthClass = 'max-w-xl') {
        modalContainer.innerHTML = content;
        modalContainer.className = `bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full ${maxWidthClass} max-h-[90vh] flex flex-col animate-slide-in-up`;
        modalOverlay.classList.remove('hidden');
        modalContainer.querySelector('.modal-close-btn')?.addEventListener('click', hideModal);
    }

    function hideModal() {
        modalOverlay.classList.add('hidden');
        modalContainer.innerHTML = '';
    }

    async function showConfirmationModal(message) {
        return new Promise(resolve => {
            const content = `
                <div class="p-6 text-center">
                    <p class="mb-6 text-lg text-gray-800 dark:text-gray-200">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Oui, supprimer</button>
                        <button id="confirm-no" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Annuler</button>
                    </div>
                </div>
            `;
            showModal(content, 'max-w-sm');
            document.getElementById('confirm-yes').onclick = () => { hideModal(); resolve(true); };
            document.getElementById('confirm-no').onclick = () => { hideModal(); resolve(false); };
        });
    }

    const getTimeStamp = () => new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'medium' });

    // --- GESTION DES PR√âF√âRENCES & PSEUDOS ---
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        userPreferences.theme = theme;
    }

    async function saveUserPreferences(prefs) {
        if (!userId) return;
        const prefRef = doc(db, `artifacts/${appId}/users/${userId}/${COLLECTIONS.USER_PREFERENCES}`, 'settings');
        try {
            await setDoc(prefRef, prefs, { merge: true });
        } catch (error) {
            console.error("Erreur de sauvegarde des pr√©f√©rences:", error);
        }
    }

    async function loadUserPreferences() {
        if (!userId) return userPreferences;
        const prefRef = doc(db, `artifacts/${appId}/users/${userId}/${COLLECTIONS.USER_PREFERENCES}`, 'settings');
        try {
            const docSnap = await getDoc(prefRef);
            if (docSnap.exists()) {
                return { ...userPreferences, ...docSnap.data() };
            }
            return userPreferences;
        } catch (error) {
            console.error("Erreur de chargement des pr√©f√©rences:", error);
            return userPreferences;
        }
    }
    
    async function getNicknameByUserId(uid) {
        if (nicknameCache[uid]) return nicknameCache[uid];
        const prefRef = doc(db, `artifacts/${appId}/users/${uid}/${COLLECTIONS.USER_PREFERENCES}`, 'settings');
        try {
            const docSnap = await getDoc(prefRef);
            if (docSnap.exists() && docSnap.data().nickname) {
                nicknameCache[uid] = docSnap.data().nickname;
                return docSnap.data().nickname;
            }
        } catch(e) { /* ignore */ }
        return uid.substring(0,8); // fallback
    }

    function showPreferencesModal() {
        const content = `
            <div class="flex-shrink-0 p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Pr√©f√©rences</h3>
                <button class="modal-close-btn text-3xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-lg font-medium mb-2">Votre Pseudonyme</label>
                    <div class="flex gap-2">
                        <input type="text" id="nickname-input" value="${userPreferences.nickname || ''}" placeholder="Choisissez un pseudo" class="flex-grow p-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                        <button id="save-nickname-btn" class="bg-blue-600 text-white px-4 rounded-lg">Sauvegarder</button>
                    </div>
                </div>
                <div>
                    <label class="block text-lg font-medium mb-2">Th√®me d'affichage</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 p-3 border dark:border-gray-600 rounded-lg cursor-pointer">
                            <input type="radio" name="theme" value="light" ${userPreferences.theme === 'light' ? 'checked' : ''}>
                            ‚òÄÔ∏è Clair
                        </label>
                        <label class="flex items-center gap-2 p-3 border dark:border-gray-600 rounded-lg cursor-pointer">
                            <input type="radio" name="theme" value="dark" ${userPreferences.theme === 'dark' ? 'checked' : ''}>
                            üåô Sombre
                        </label>
                    </div>
                </div>
                 <div>
                    <label class="block text-lg font-medium mb-2">Mode de d√©marrage par d√©faut</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 p-3 border dark:border-gray-600 rounded-lg cursor-pointer">
                            <input type="radio" name="startupMode" value="pro" ${userPreferences.startupMode === 'pro' ? 'checked' : ''}>
                            üè¢ Pro
                        </label>
                        <label class="flex items-center gap-2 p-3 border dark:border-gray-600 rounded-lg cursor-pointer">
                            <input type="radio" name="startupMode" value="perso" ${userPreferences.startupMode === 'perso' ? 'checked' : ''}>
                            üè† Perso
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-lg font-medium mb-2">Votre ID Utilisateur (pour le partage)</label>
                    <div class="flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-mono text-gray-600 dark:text-gray-400 truncate">${userId}</span>
                        <button id="copy-pref-id-btn" class="p-1 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200" title="Copier l'ID">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
        showModal(content, 'max-w-md');
        
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                applyTheme(e.target.value);
                saveUserPreferences({ theme: e.target.value });
            });
        });
        document.querySelectorAll('input[name="startupMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                userPreferences.startupMode = e.target.value;
                saveUserPreferences({ startupMode: e.target.value });
            });
        });
        document.getElementById('copy-pref-id-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(userId);
            showToast("ID Utilisateur copi√© !");
        });
        document.getElementById('save-nickname-btn').addEventListener('click', handleSaveNickname);
    }

    async function handleSaveNickname() {
        const newNickname = document.getElementById('nickname-input').value.trim().toLowerCase();
        if (!newNickname || newNickname === userPreferences.nickname) return;

        try {
            await runTransaction(db, async (transaction) => {
                const newNicknameRef = doc(db, `artifacts/${appId}/${COLLECTIONS.NICKNAMES}`, newNickname);
                const docSnap = await transaction.get(newNicknameRef);

                if (docSnap.exists() && docSnap.data().userId !== userId) {
                    throw new Error("Ce pseudonyme est d√©j√† utilis√©.");
                }

                if (userPreferences.nickname) {
                    const oldNicknameRef = doc(db, `artifacts/${appId}/${COLLECTIONS.NICKNAMES}`, userPreferences.nickname);
                    transaction.delete(oldNicknameRef);
                }
                
                transaction.set(newNicknameRef, { userId: userId });
                const prefRef = doc(db, `artifacts/${appId}/users/${userId}/${COLLECTIONS.USER_PREFERENCES}`, 'settings');
                transaction.set(prefRef, { nickname: newNickname }, { merge: true });
            });

            userPreferences.nickname = newNickname;
            document.getElementById('userNicknameDisplay').textContent = newNickname;
            showToast("Pseudonyme mis √† jour !", "success");
        } catch (error) {
            console.error("Erreur lors de la sauvegarde du pseudonyme:", error);
            showToast(error.message || "√âchec de la sauvegarde du pseudonyme.", "error");
        }
    }

    // --- GESTION DE L'AUTHENTIFICATION ---
    onAuthStateChanged(auth, async (user) => {
        const userNicknameEl = document.getElementById('userNicknameDisplay');
        if (user) {
            userId = user.uid;
            userPreferences = await loadUserPreferences();
            
            applyTheme(userPreferences.theme);
            
            if (userPreferences.startupMode && NAV_CONFIG[userPreferences.startupMode]) {
                currentMode = userPreferences.startupMode;
            } else {
                currentMode = 'perso';
            }

            document.getElementById('userEmailDisplay').textContent = user.isAnonymous ? 'Mode Invit√©' : (user.email || 'Connect√©');
            userNicknameEl.textContent = userPreferences.nickname || 'Pas de pseudo';
            
            document.getElementById('authBtn').classList.add('hidden');
            document.getElementById('preferencesBtn').classList.remove('hidden');
            document.getElementById('signOutBtn').classList.remove('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
            if (user.email === ADMIN_EMAIL) {
                document.getElementById('adminBtn').classList.remove('hidden');
            }
            
            hideModal();
            setupRealtimeListeners();
            setMode(currentMode);
        } else {
            userId = null;
            applyTheme('light');
            document.getElementById('userEmailDisplay').textContent = 'Non connect√©';
            userNicknameEl.textContent = '';
            document.getElementById('authBtn').classList.remove('hidden');
            document.getElementById('preferencesBtn').classList.add('hidden');
            document.getElementById('adminBtn').classList.add('hidden');
            document.getElementById('signOutBtn').classList.add('hidden');
            document.getElementById('modeSelector').classList.add('hidden');
            document.getElementById('main-nav').classList.add('hidden');
            pageContent.innerHTML = '';
            detachRealtimeListeners();
            showAuthModal();
        }
    });

    function showAuthModal() {
        const content = `
            <div class="p-6 md:p-8 relative">
                <button class="modal-close-btn absolute top-4 right-5 text-3xl font-bold text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">&times;</button>
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">Connexion / Inscription</h3>
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Email :</label>
                        <input type="email" id="email" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" placeholder="votre@email.com" autocomplete="email">
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Mot de passe :</label>
                        <input type="password" id="password" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" placeholder="********" autocomplete="current-password">
                    </div>
                    <div class="flex flex-col gap-3 pt-2">
                        <button id="signInEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Se connecter</button>
                        <button id="signUpEmailBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Cr√©er un compte</button>
                    </div>
                    <div class="relative flex py-4 items-center">
                        <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400 dark:text-gray-500">OU</span><div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    </div>
                     <button id="signInGoogleBtn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-3 border border-gray-300 dark:border-gray-600 w-full">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5"> Se connecter avec Google
                    </button>
                </div>
            </div>
        `;
        showModal(content);
        document.getElementById('signInEmailBtn').addEventListener('click', handleEmailSignIn);
        document.getElementById('signUpEmailBtn').addEventListener('click', handleEmailSignUp);
        document.getElementById('signInGoogleBtn').addEventListener('click', handleGoogleSignIn);
    }
    
    async function handleEmailSignIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try { await signInWithEmailAndPassword(auth, email, password); showToast('Connexion r√©ussie !', 'success'); } 
        catch (error) { showToast(`Erreur: ${error.code}`, 'error'); }
    }
    async function handleEmailSignUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try { await createUserWithEmailAndPassword(auth, email, password); showToast('Inscription r√©ussie !', 'success'); } 
        catch (error) { showToast(`Erreur: ${error.code}`, 'error'); }
    }
    async function handleGoogleSignIn() {
        try { await signInWithPopup(auth, googleProvider); showToast('Connexion Google r√©ussie !', 'success'); } 
        catch (error) { showToast(`Erreur: ${error.code}`, 'error'); }
    }

    // --- GESTION DES DONN√âES (FIRESTORE) ---
    function detachRealtimeListeners() {
        unsubscribeListeners.forEach(unsubscribe => unsubscribe());
        unsubscribeListeners = [];
    }

    function setupRealtimeListeners() {
        if (!userId) return;
        detachRealtimeListeners();

        const privateCollections = Object.values(NAV_CONFIG).flat().map(c => c.type).filter(t => t !== COLLECTIONS.COLLABORATIVE_DOCS);
        
        [...new Set(privateCollections)].forEach(collectionName => {
            const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
            const q = query(collection(db, path));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                allDataCache[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentPageContent();
            }, (error) => console.error(`Erreur d'√©coute sur ${collectionName}:`, error));
            unsubscribeListeners.push(unsubscribe);
        });

        const collabPath = `artifacts/${appId}/${COLLECTIONS.COLLABORATIVE_DOCS}`;
        const qCollab = query(collection(db, collabPath), where('members', 'array-contains', userId));
        const unsubscribeCollab = onSnapshot(qCollab, (snapshot) => {
            allDataCache[COLLECTIONS.COLLABORATIVE_DOCS] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), isShared: true }));
            renderCurrentPageContent();
        }, (error) => console.error(`Erreur d'√©coute sur ${COLLECTIONS.COLLABORATIVE_DOCS}:`, error));
        unsubscribeListeners.push(unsubscribeCollab);
    }

    // --- LOGIQUE DE RENDU ET D'INTERFACE ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('#modeSelector button').forEach(btn => {
            const isActive = btn.dataset.mode === mode;
            btn.classList.toggle('bg-white', isActive);
            btn.classList.toggle('dark:bg-gray-300', isActive);
            btn.classList.toggle('text-blue-700', isActive);
            btn.classList.toggle('dark:text-gray-900', isActive);
            btn.classList.toggle('text-white', !isActive);
        });
        
        const navItems = NAV_CONFIG[mode];
        mainNav.innerHTML = navItems.map(item => `
            <button class="nav-button text-white/80 hover:text-white hover:bg-white/20 px-3 py-2 rounded-md text-sm font-medium transition-colors" data-target="${item.id}">
                <span class="mr-1">${item.icon}</span>${item.title}
            </button>
        `).join('');
        
        showPage(navItems[0].id);
    }

    function showPage(id) {
        currentPageId = id;
        
        mainNav.querySelectorAll('.nav-button').forEach(button => {
            const isActive = button.dataset.target === id;
            button.classList.toggle('bg-white/20', isActive);
            button.classList.toggle('dark:bg-gray-300/20', isActive);
            button.classList.toggle('font-bold', isActive);
        });

        const config = NAV_CONFIG[currentMode].find(p => p.id === id);
        if (!config) return;

        const pageFragment = document.getElementById('page-template').content.cloneNode(true);
        pageFragment.querySelector('.page-title').textContent = config.title;
        pageFragment.querySelector('.page-description').textContent = config.description;
        
        const addButton = pageFragment.querySelector('.add-new-item-btn');
        if (config.type === COLLECTIONS.COLLABORATIVE_DOCS || config.id === 'actionsTerminees' || config.id === 'todo_perso_terminees') {
            addButton.remove();
        } else {
            addButton.onclick = () => showItemModal(null, config.type);
        }

        pageContent.innerHTML = '';
        pageContent.appendChild(pageFragment);

        renderCurrentPageContent();
    }

    async function renderCurrentPageContent() {
        const container = pageContent.querySelector('.grid-container');
        if (!container) return;

        const searchTerm = (pageContent.querySelector('.searchBar')?.value || '').toLowerCase();
        const config = NAV_CONFIG[currentMode].find(p => p.id === currentPageId);
        if (!config) return;

        let data = [];
        if (config.type === COLLECTIONS.COLLABORATIVE_DOCS) {
            data = allDataCache[COLLECTIONS.COLLABORATIVE_DOCS] || [];
        } else {
            const privateData = allDataCache[config.type] || [];
            const sharedData = (allDataCache[COLLECTIONS.COLLABORATIVE_DOCS] || []).filter(doc => doc.originalType === config.type);
            data = [...privateData, ...sharedData];
        }
        
        if (config.id === 'actionsTerminees' || config.id === 'todo_perso_terminees') {
            data = data.filter(entry => entry.isCompleted);
        } else if (config.type === COLLECTIONS.ACTIONS || config.type === COLLECTIONS.TODO) {
            data = data.filter(entry => !entry.isCompleted);
        }

        if (searchTerm) {
            data = data.filter(entry => JSON.stringify(entry).toLowerCase().includes(searchTerm));
        }
        
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 col-span-full mt-12 text-lg">üìÇ<br>${searchTerm ? 'Aucun r√©sultat trouv√©.' : 'Rien √† afficher ici.'}</p>`;
            return;
        }

        for (const entry of data) {
            const cardEl = await createCardElement(entry, config);
            container.appendChild(cardEl);
        }
    }

    async function createCardElement(entry, pageConfig) {
        const cardTemplate = document.getElementById('card-template').content.cloneNode(true);
        const card = cardTemplate.firstElementChild;
        
        card.dataset.id = entry.id;
        card.dataset.type = entry.isShared ? COLLECTIONS.COLLABORATIVE_DOCS : pageConfig.type;
        card.dataset.originalType = entry.originalType || pageConfig.type;

        // Wallet items should open in a new tab, others open the modal
        if (card.dataset.originalType === COLLECTIONS.WALLET) {
             card.onclick = (e) => {
                e.stopPropagation(); // prevent modal from opening
                window.open(entry.fileUrl, '_blank');
            };
            // Add a separate button/icon for editing/deleting wallet items
            const editBtn = document.createElement('button');
            editBtn.innerHTML = '‚öôÔ∏è';
            editBtn.className = 'absolute bottom-4 right-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                showItemModal(entry, card.dataset.type);
            };
            card.querySelector('.card-footer').appendChild(editBtn);
        } else {
            card.onclick = () => showItemModal(entry, card.dataset.type);
        }
        
        card.querySelector('.card-title').textContent = entry.titre || 'Sans titre';
        
        const iconConfig = Object.values(NAV_CONFIG).flat().find(c => c.type === card.dataset.originalType);
        card.querySelector('.card-icon').textContent = iconConfig?.icon || '‚ùì';
        
        const summaryEl = card.querySelector('.card-summary');
        if (card.dataset.originalType === COLLECTIONS.COURSES) {
             const items = entry.items || [];
             const completedItems = items.filter(item => item.completed).length;
             summaryEl.textContent = `${completedItems} / ${items.length} articles coch√©s`;
        } else if (card.dataset.originalType === COLLECTIONS.WALLET) {
            summaryEl.textContent = entry.fileName || 'Fichier';
        } else if (entry.contenu) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = entry.contenu;
            const textContent = tempDiv.textContent || tempDiv.innerText || "";
            summaryEl.textContent = `${textContent.substring(0, 100)}...`;
        }

        const tagsContainer = card.querySelector('.tags-display');
        (entry.tags || []).forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 px-2 py-1 rounded-full text-xs font-semibold';
            tagEl.textContent = tag;
            tagsContainer.appendChild(tagEl);
        });

        if (entry.isShared) {
            const ownerNickname = await getNicknameByUserId(entry.ownerId);
            card.querySelector('.owner-display').textContent = `Par ${ownerNickname}`;
        }

        return card;
    }

    // --- LOGIQUE DE LA MODALE D'√âDITION/CR√âATION ---
    async function showItemModal(entry, type) {
        const isNew = !entry;
        const data = isNew ? { titre: '', contenu: '', tags: [] } : entry;
        const isShared = data.isShared;
        const originalType = data.originalType || type;

        let formHtml = '';
        formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Titre</label><input type="text" data-field="titre" value="${data.titre || ''}" placeholder="Titre de l'√©l√©ment" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></div>`;
        
        if (originalType === COLLECTIONS.COURSES) {
            formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Articles</label><div id="course-items-list" class="mt-2 space-y-2"></div></div>`;
            formHtml += `<div class="flex gap-2"><input type="text" id="new-course-item-input" placeholder="Nouvel article" class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"><button type="button" id="add-course-item-btn" class="bg-blue-500 text-white px-4 rounded-lg">Ajouter</button></div>`;
        } else if (originalType === COLLECTIONS.WALLET) {
            // Pour la modification, on affiche le nom du fichier. Pour la cr√©ation, on montre l'input.
            if (isNew) {
                 formHtml += `
                    <div class="mb-4">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Fichier (PDF, JPG, PNG)</label>
                        <input type="file" id="file-input" accept="image/jpeg,image/png,application/pdf" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                    </div>
                    <div id="upload-progress" class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 hidden mb-4">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                `;
            } else {
                 formHtml += `
                    <div class="mb-4">
                         <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Fichier Actuel</label>
                         <div class="p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700">
                            <a href="${data.fileUrl}" target="_blank" class="text-blue-500 hover:underline">${data.fileName}</a>
                         </div>
                    </div>
                 `;
            }
        } else { 
            formHtml += `
                <div class="mb-4 flex-grow flex flex-col">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Contenu</label>
                    <div class="formatting-toolbar flex items-center gap-1 mb-2 p-1 bg-gray-100 dark:bg-gray-700 rounded-md">
                        <button type="button" data-command="bold" class="font-bold w-8 h-8 rounded hover:bg-gray-200 dark:hover:bg-gray-600">G</button>
                        <button type="button" data-command="underline" class="underline w-8 h-8 rounded hover:bg-gray-200 dark:hover:bg-gray-600">S</button>
                        <button type="button" data-command="strikeThrough" class="line-through w-8 h-8 rounded hover:bg-gray-200 dark:hover:bg-gray-600">B</button>
                    </div>
                    <div data-field="contenu" contenteditable="true" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 flex-grow min-h-[150px]">${data.contenu || ''}</div>
                </div>`;
        }

        if (originalType !== COLLECTIONS.COURSES && originalType !== COLLECTIONS.WALLET) {
            formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Tags (s√©par√©s par des virgules)</label><input type="text" data-field="tags" value="${(data.tags || []).join(', ')}" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></div>`;
        }

        let shareHtml = '';
        if (!isNew && SHAREABLE_TYPES.includes(originalType)) {
            let recentCollaboratorsHtml = '';
            if (allDataCache[COLLECTIONS.COLLABORATIVE_DOCS]) {
                const recentIds = new Set(allDataCache[COLLECTIONS.COLLABORATIVE_DOCS].flatMap(doc => doc.members));
                recentIds.delete(userId);
                if (recentIds.size > 0) {
                    recentCollaboratorsHtml += `<div class="mt-2 text-xs text-gray-500 dark:text-gray-400">R√©cents :</div><div class="flex flex-wrap gap-2 mt-1">`;
                    for (const uid of recentIds) {
                        const nickname = await getNicknameByUserId(uid);
                        recentCollaboratorsHtml += `<button data-nickname="${nickname}" class="recent-contact-btn bg-gray-200 dark:bg-gray-600 text-xs px-2 py-1 rounded-full">${nickname}</button>`;
                    }
                    recentCollaboratorsHtml += `</div>`;
                }
            }

            shareHtml = `<div class="mt-6 p-4 border dark:border-gray-700 rounded-lg">
                <h4 class="font-bold mb-2">Partage</h4>
                ${isShared ? `<p class="text-sm mb-2">Partag√© avec : ${data.members.length} utilisateur(s)</p>` : ''}
                <div class="flex gap-2">
                    <input id="share-user-id" type="text" placeholder="Pseudo de l'utilisateur" class="flex-grow p-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                    <button id="share-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ü§ù Inviter</button>
                </div>
                ${isShared && data.ownerId === userId ? `<button id="unshare-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-2 w-full">Arr√™ter le partage</button>` : ''}
                ${recentCollaboratorsHtml}
            </div>`;
        }
        
        let actionsHtml = '<div class="modal-actions flex flex-wrap gap-3 justify-end">';
        if (isNew) {
            actionsHtml += `<button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">üíæ Enregistrer</button>`;
        } else {
            if ([COLLECTIONS.ACTIONS, COLLECTIONS.TODO].includes(originalType)) {
                if (data.isCompleted) {
                    actionsHtml += `<button data-action="toggleComplete" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">‚Ü©Ô∏è R√©-ouvrir</button>`;
                } else {
                    actionsHtml += `<button data-action="toggleComplete" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">‚úÖ Terminer</button>`;
                }
            }
            actionsHtml += `<button data-action="delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">üóëÔ∏è Supprimer</button>`;
        }
        actionsHtml += '</div>';

        const modalTitle = isNew ? `Ajouter un √©l√©ment` : `Modifier: ${data.titre}`;
        const finalContent = `
            <div class="flex-shrink-0 p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">${modalTitle}</h3>
                <button class="modal-close-btn text-3xl font-bold text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">&times;</button>
            </div>
            <div class="p-4 flex-grow overflow-y-auto flex flex-col" id="modal-form-content">
                ${formHtml}
                ${shareHtml}
            </div>
            <div class="flex-shrink-0 p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                ${actionsHtml}
            </div>
        `;

        showModal(finalContent, 'max-w-2xl');
        
        if (originalType === COLLECTIONS.COURSES) {
            renderCourseItems(data.items || [], isNew ? null : entry.id, isShared);
        }

        attachModalListeners(entry, type);
    }

    function attachModalListeners(entry, type) {
        const isNew = !entry;
        const originalType = entry?.originalType || type;

        if (isNew) {
            const saveBtn = document.getElementById('save-btn');
            if (saveBtn) {
                saveBtn.onclick = () => saveEntry(null, type, saveBtn);
            }
        } else {
            const deleteBtn = modalContainer.querySelector('[data-action="delete"]');
            if(deleteBtn) deleteBtn.onclick = () => deleteEntry(type, entry.id, entry.isShared, entry.filePath);
            
            const shareBtn = modalContainer.querySelector('#share-btn');
            if(shareBtn) shareBtn.onclick = () => handleSharing(entry, type);

            const unshareBtn = modalContainer.querySelector('#unshare-btn');
            if(unshareBtn) unshareBtn.onclick = () => handleUnsharing(entry);

            const toggleCompleteBtn = modalContainer.querySelector('[data-action="toggleComplete"]');
            if(toggleCompleteBtn) toggleCompleteBtn.onclick = () => markAsCompleted(type, entry.id, !entry.isCompleted);
        }

        if (originalType === COLLECTIONS.COURSES && !isNew) {
            const addBtn = document.getElementById('add-course-item-btn');
            const addInput = document.getElementById('new-course-item-input');
            addBtn.onclick = () => addOrUpdateCourseItem(entry.id, type);
            addInput.onkeydown = (e) => { if(e.key === 'Enter') { e.preventDefault(); addOrUpdateCourseItem(entry.id, type); }};
        }

        modalContainer.querySelectorAll('.formatting-toolbar button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const command = e.currentTarget.dataset.command;
                document.execCommand(command, false, null);
                modalContainer.querySelector('[contenteditable]').focus();
            });
        });

        modalContainer.querySelectorAll('[data-field]').forEach(input => {
            if (input.isContentEditable) {
                if (!isNew) {
                    input.addEventListener('blur', (e) => {
                        handleUpdate(type, entry.id, e.target.dataset.field, e.target.innerHTML);
                    });
                }
            } else { // C'est un input ou textarea
                 if (!isNew) {
                    input.addEventListener('blur', (e) => {
                        handleUpdate(type, entry.id, e.target.dataset.field, e.target.value);
                    });
                }
            }
        });

        modalContainer.querySelectorAll('.recent-contact-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                document.getElementById('share-user-id').value = e.currentTarget.dataset.nickname;
            });
        });
    }

    // --- CRUD OPERATIONS ---
    async function saveEntry(id, collectionName, saveBtn = null) {
        const isNew = !id;
        const form = document.getElementById('modal-form-content');
        const titreInput = form.querySelector('[data-field="titre"]');

        if (!titreInput || !titreInput.value.trim()) {
            showToast("Le titre est obligatoire.", "error");
            return;
        }

        // Cas sp√©cial pour le portefeuille (upload de fichier)
        if (collectionName === COLLECTIONS.WALLET) {
            handleFileUpload(titreInput.value.trim(), saveBtn);
            return;
        }

        let newEntryData = {};
        form.querySelectorAll('[data-field]').forEach(input => {
            const field = input.dataset.field;
            let value = input.isContentEditable ? input.innerHTML : input.value;
            if (field === 'tags') value = value.split(',').map(t => t.trim()).filter(Boolean);
            newEntryData[field] = value;
        });

        if (isNew) {
            newEntryData.ownerId = userId;
            if (collectionName === COLLECTIONS.COURSES) {
                newEntryData.items = []; 
            }
            if (collectionName === COLLECTIONS.ACTIONS || collectionName === COLLECTIONS.TODO) {
                newEntryData.isCompleted = false;
            }
        }

        try {
            const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
            if (isNew) {
                await addDoc(collection(db, path), newEntryData);
                showToast("√âl√©ment ajout√© !", 'success');
            }
            hideModal();
        } catch (error) {
            console.error("Erreur d'enregistrement:", error);
            showToast("Erreur lors de l'enregistrement.", "error");
        }
    }

    // --- [NOUVEAU] Fonction pour traduire les erreurs de Storage ---
    function getFirebaseStorageError(errorCode) {
        switch (errorCode) {
            case 'storage/unauthorized':
                return "Vous n'avez pas la permission. V√©rifiez les r√®gles de s√©curit√© de Storage et la configuration CORS.";
            case 'storage/canceled':
                return "L'envoi a √©t√© annul√©.";
            case 'storage/unknown':
                return "Une erreur inconnue est survenue. V√©rifiez la console et la configuration CORS.";
            case 'storage/object-not-found':
                return "Le fichier n'a pas √©t√© trouv√©.";
            case 'storage/bucket-not-found':
                return "L'espace de stockage (bucket) est introuvable.";
            case 'storage/project-not-found':
                return "Le projet Firebase est introuvable.";
            case 'storage/quota-exceeded':
                return "Le quota de stockage a √©t√© d√©pass√©.";
            case 'storage/unauthenticated':
                return "Vous devez √™tre connect√© pour effectuer cette action.";
            default:
                return `Erreur non identifi√©e (${errorCode}).`;
        }
    }

    function handleFileUpload(titre, saveBtn) {
        if (!userId) {
            showToast("Erreur: Utilisateur non connect√©.", "error");
            return;
        }
        if (!saveBtn) return;

        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];

        if (!file) {
            showToast("Veuillez s√©lectionner un fichier.", "error");
            return;
        }

        const progressContainer = document.getElementById('upload-progress');
        const progressBar = document.getElementById('upload-progress-bar');

        saveBtn.disabled = true;
        saveBtn.textContent = 'Envoi en cours...';
        progressContainer.classList.remove('hidden');

        const filePath = `artifacts/${appId}/users/${userId}/wallet/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, filePath);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBar.style.width = progress + '%';
            },
            (error) => {
                // [AM√âLIOR√â] Log et affichage de l'erreur d√©taill√©e
                console.error("Erreur d'upload d√©taill√©e:", error);
                showToast(getFirebaseStorageError(error.code), "error");
                
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Enregistrer';
                progressContainer.classList.add('hidden');
            },
            () => {
                getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                    const walletCollection = collection(db, `artifacts/${appId}/users/${userId}/${COLLECTIONS.WALLET}`);
                    await addDoc(walletCollection, {
                        titre: titre,
                        fileName: file.name,
                        fileUrl: downloadURL,
                        filePath: filePath,
                        ownerId: userId,
                        createdAt: new Date()
                    });
                    showToast("Fichier envoy√© et enregistr√© !", "success");
                    hideModal();
                }).catch(error => {
                    console.error("Erreur lors de la cr√©ation de l'entr√©e Firestore:", error);
                    showToast("Erreur lors de la sauvegarde des informations.", "error");
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Enregistrer';
                    progressContainer.classList.add('hidden');
                });
            }
        );
    }


    async function handleUpdate(collectionName, id, field, value) {
        if (!userId) return;
        const isShared = collectionName === COLLECTIONS.COLLABORATIVE_DOCS;
        const path = isShared ? `artifacts/${appId}/${collectionName}` : `artifacts/${appId}/users/${userId}/${collectionName}`;
        const docRef = doc(db, path, id);
        try {
            let updateValue = value;
            if (field === 'tags') updateValue = value.split(',').map(t => t.trim()).filter(Boolean);
            await updateDoc(docRef, { [field]: updateValue });
            showToast("Mise √† jour enregistr√©e.", 'success');
        } catch (error) {
            console.error("Erreur de mise √† jour:", error);
            showToast("Erreur de mise √† jour.", "error");
        }
    }
    
    async function deleteEntry(collectionName, id, isShared, filePath) {
        const confirmed = await showConfirmationModal("Supprimer cet √©l√©ment d√©finitivement ?");
        if (confirmed) {
            const basePath = isShared ? `artifacts/${appId}/${COLLECTIONS.COLLABORATIVE_DOCS}` : `artifacts/${appId}/users/${userId}/${collectionName}`;
            const docRef = doc(db, basePath, id);

            try {
                if (filePath) {
                    try {
                        const fileRef = ref(storage, filePath);
                        await deleteObject(fileRef);
                    } catch (storageError) {
                        console.warn("Le fichier √† supprimer du stockage n'a pas √©t√© trouv√©, il a peut-√™tre d√©j√† √©t√© supprim√©:", storageError);
                    }
                }
                
                await deleteDoc(docRef);
                showToast("√âl√©ment supprim√©.", 'success');
                hideModal();
            } catch (error) {
                console.error("Erreur de suppression:", error);
                showToast("Erreur de suppression.", "error");
            }
        }
    }


    async function markAsCompleted(collectionName, id, isCompleted) {
        if (!userId) return;
        const isShared = collectionName === COLLECTIONS.COLLABORATIVE_DOCS;
        const path = isShared ? `artifacts/${appId}/${collectionName}` : `artifacts/${appId}/users/${userId}/${collectionName}`;
        const docRef = doc(db, path, id);
        try {
            await updateDoc(docRef, { isCompleted: isCompleted });
            showToast(`T√¢che mise √† jour.`, 'success');
            hideModal();
        } catch (error) {
            console.error("Erreur de mise √† jour:", error);
            showToast("Erreur de mise √† jour.", "error");
        }
    }
    
    // --- LOGIQUE DE PARTAGE ---
    async function handleSharing(entry, type) {
        const targetNickname = document.getElementById('share-user-id').value.trim().toLowerCase();
        if (!targetNickname) {
            showToast("Veuillez entrer un pseudonyme.", "error");
            return;
        }

        const nicknameRef = doc(db, `artifacts/${appId}/${COLLECTIONS.NICKNAMES}`, targetNickname);
        const nicknameSnap = await getDoc(nicknameRef);

        if (!nicknameSnap.exists()) {
            showToast("Pseudonyme non trouv√©.", "error");
            return;
        }
        const targetUserId = nicknameSnap.data().userId;

        if (entry.isShared) {
            const docRef = doc(db, `artifacts/${appId}/${COLLECTIONS.COLLABORATIVE_DOCS}`, entry.id);
            await updateDoc(docRef, { members: arrayUnion(targetUserId) });
            showToast("Utilisateur ajout√© au partage !", "success");
        } else {
            const batch = writeBatch(db);
            const originalDocRef = doc(db, `artifacts/${appId}/users/${userId}/${type}`, entry.id);
            const newDocRef = doc(collection(db, `artifacts/${appId}/${COLLECTIONS.COLLABORATIVE_DOCS}`));

            const newDocData = { ...entry, ownerId: userId, members: [userId, targetUserId], originalType: type };
            delete newDocData.id;
            delete newDocData.isShared;

            batch.set(newDocRef, newDocData);
            batch.delete(originalDocRef);

            await batch.commit();
            showToast("Document partag√© avec succ√®s !", "success");
            hideModal();
        }
    }

    async function handleUnsharing(entry) {
        if (!entry || !entry.isShared || entry.ownerId !== userId) return;

        const confirmed = await showConfirmationModal("Arr√™ter le partage rendra ce document √† nouveau priv√©. Les autres collaborateurs perdront l'acc√®s. Continuer ?");
        if (confirmed) {
            try {
                const batch = writeBatch(db);

                const sharedDocRef = doc(db, `artifacts/${appId}/${COLLECTIONS.COLLABORATIVE_DOCS}`, entry.id);
                const privateDocData = { ...entry };
                
                delete privateDocData.members;
                delete privateDocData.ownerId;
                delete privateDocData.isShared;
                delete privateDocData.id;
                
                const targetCollection = entry.originalType;
                delete privateDocData.originalType;

                const newPrivateDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/${targetCollection}`));

                batch.set(newPrivateDocRef, privateDocData);
                batch.delete(sharedDocRef);

                await batch.commit();
                showToast("Le partage a √©t√© arr√™t√©.", "success");
                hideModal();

            } catch (error) {
                console.error("Erreur lors de l'arr√™t du partage:", error);
                showToast("Erreur lors de l'arr√™t du partage.", "error");
            }
        }
    }

    // --- LOGIQUE SP√âCIFIQUE LISTE DE COURSES ---
    function renderCourseItems(items, docId, isShared) {
        const container = document.getElementById('course-items-list');
        if (!container) return;

        const grouped = (items || []).reduce((acc, item) => {
            const category = item.category || 'Autre';
            if (!acc[category]) {
                acc[category] = [];
            }
            acc[category].push(item);
            return acc;
        }, {});

        const sortedCategories = Object.keys(grouped).sort();

        container.innerHTML = sortedCategories.map(category => `
            <div class="category-group mt-4">
                <h4 class="text-lg font-bold text-blue-600 dark:text-blue-400 border-b-2 border-blue-200 dark:border-blue-800 pb-1 mb-2">${category}</h4>
                ${grouped[category].map(item => {
                    const itemIndex = items.findIndex(i => i.text === item.text && i.category === item.category);
                    return `
                    <div class="flex items-center justify-between p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" data-item-index="${itemIndex}" ${item.completed ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 bg-transparent">
                            <span class="ml-3 text-gray-700 dark:text-gray-300 ${item.completed ? 'line-through text-gray-400 dark:text-gray-500' : ''}">${item.text}</span>
                        </label>
                        <button data-action="delete-course-item" data-item-index="${itemIndex}" class="text-gray-400 hover:text-red-500 text-xl">üóëÔ∏è</button>
                    </div>
                `}).join('')}
            </div>
        `).join('');

        if(docId) {
            const collectionType = isShared ? COLLECTIONS.COLLABORATIVE_DOCS : COLLECTIONS.COURSES;
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.onchange = (e) => addOrUpdateCourseItem(docId, collectionType, parseInt(e.target.dataset.itemIndex), e.target.checked);
            });
            container.querySelectorAll('[data-action="delete-course-item"]').forEach(btn => {
                btn.onclick = (e) => addOrUpdateCourseItem(docId, collectionType, parseInt(e.currentTarget.dataset.itemIndex), null, true);
            });
        }
    }

    async function addOrUpdateCourseItem(docId, collectionType, indexToUpdate = null, isCompleted = null, toDelete = false) {
        if (!docId) return;

        const path = collectionType === COLLECTIONS.COLLABORATIVE_DOCS ? `artifacts/${appId}/${collectionType}` : `artifacts/${appId}/users/${userId}/${collectionType}`;
        const docRef = doc(db, path, docId);
        
        try {
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return;

            let currentItems = docSnap.data().items || [];
            
            if (toDelete && indexToUpdate !== null) {
                currentItems.splice(indexToUpdate, 1);
            } else if (indexToUpdate !== null) {
                currentItems[indexToUpdate].completed = isCompleted;
            } else {
                const input = document.getElementById('new-course-item-input');
                const addButton = document.getElementById('add-course-item-btn');
                const newItemText = input.value.trim();
                if (newItemText) {
                    addButton.disabled = true;
                    addButton.textContent = '...';

                    let chatHistory = [];
                    const prompt = `Classe l'article de course suivant dans l'une de ces cat√©gories : Fruits & L√©gumes, Viandes & Poissons, Boulangerie, Produits Laitiers & ≈íufs, √âpicerie Sal√©e, √âpicerie Sucr√©e, Boissons, Surgel√©s, Hygi√®ne & Beaut√©, Entretien & Nettoyage, Autre. Ne r√©ponds que par le nom de la cat√©gorie. Article : "${newItemText}"`;
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            const errorBody = await response.json();
                            console.error("Erreur de l'API Gemini (r√©ponse non OK):", errorBody);
                            throw new Error(`API error: ${response.status}`);
                        }

                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                        
                         const category = result.candidates[0].content.parts[0].text.trim();
                         currentItems.push({ text: newItemText, completed: false, category: category });

                        } else {
                         console.warn("R√©ponse de l'API Gemini re√ßue, mais sans contenu valide. R√©ponse compl√®te:", result);
                         currentItems.push({ text: newItemText, completed: false, category: 'Autre' });
                        }

                    } catch (e) {
                        console.error("Erreur lors de l'appel √† l'API Gemini:", e);
                        currentItems.push({ text: newItemText, completed: false, category: 'Autre' }); // Fallback
                    } finally {
                        addButton.disabled = false;
                        addButton.textContent = 'Ajouter';
                        input.value = '';
                        input.focus();
                    }
                } else {
                    return;
                }
            }
            
            await updateDoc(docRef, { items: currentItems });
            renderCourseItems(currentItems, docId, collectionType === COLLECTIONS.COLLABORATIVE_DOCS);
        } catch (error) {
            console.error("Erreur de mise √† jour de la liste de courses:", error);
            showToast("Erreur de mise √† jour de la liste.", "error");
        }
    }

    // --- LOGIQUE D'ADMINISTRATION ---
    async function showAdminPanel() {
        const q = collectionGroup(db, COLLECTIONS.USER_PREFERENCES);
        const querySnapshot = await getDocs(q);
        let users = [];
        querySnapshot.forEach((doc) => {
            const pathParts = doc.ref.path.split('/');
            const uid = pathParts[pathParts.length - 3];
            users.push({ uid: uid, ...doc.data() });
        });

        const userListHtml = users.map(user => `
            <div class="flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <div>
                    <p class="font-bold">${user.nickname || 'Pas de pseudo'}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-mono">${user.uid}</p>
                </div>
                <button data-uid="${user.uid}" data-nickname="${user.nickname || ''}" class="admin-delete-user-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">Supprimer</button>
            </div>
        `).join('');

        const content = `
            <div class="flex-shrink-0 p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Panneau d'Administration</h3>
                <button class="modal-close-btn text-3xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <h4 class="text-lg font-semibold">Liste des Utilisateurs (${users.length})</h4>
                <div class="space-y-2">${userListHtml}</div>
            </div>
        `;
        showModal(content, 'max-w-2xl');

        document.querySelectorAll('.admin-delete-user-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const uidToDelete = e.currentTarget.dataset.uid;
                const nicknameToDelete = e.currentTarget.dataset.nickname;
                handleAdminDeleteUser(uidToDelete, nicknameToDelete);
            });
        });
    }

    async function handleAdminDeleteUser(uidToDelete, nicknameToDelete) {
        const confirmed = await showConfirmationModal(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur ${nicknameToDelete} (${uidToDelete}) ? Cette action est irr√©versible et supprimera son compte et toutes ses donn√©es.`);
        if (confirmed) {
            try {
                const deleteUser = httpsCallable(functions, 'deleteUserAccount');
                await deleteUser({ uidToDelete: uidToDelete, nicknameToDelete: nicknameToDelete, appId: appId });
                showToast("Utilisateur supprim√© avec succ√®s.", "success");
                showAdminPanel(); // Refresh panel
            } catch (error) {
                console.error("Erreur de suppression admin:", error);
                showToast(error.message || "Erreur lors de la suppression.", "error");
            }
        }
    }

    // --- EVENT LISTENERS INITIAUX ---
    function initializeEventListeners() {
        document.getElementById('authBtn').addEventListener('click', showAuthModal);
        document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth).then(() => showToast('D√©connect√©.', 'info')));
        document.getElementById('preferencesBtn').addEventListener('click', showPreferencesModal);
        document.getElementById('adminBtn').addEventListener('click', showAdminPanel);
        
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) hideModal();
        });
        modeSelector.addEventListener('click', e => {
            const button = e.target.closest('button');
            if(button) setMode(button.dataset.mode);
        });
        mainNav.addEventListener('click', e => {
            const button = e.target.closest('.nav-button');
            if (button) showPage(button.dataset.target);
        });
        pageContent.addEventListener('input', e => {
            if(e.target.matches('.searchBar')) renderCurrentPageContent();
        });
        pageContent.addEventListener('click', e => {
            const card = e.target.closest('.card');
            if (card && card.onclick) { // Check if onclick is defined before proceeding
                // The card's own onclick handler will be triggered.
                // No need to find the entry again here.
            }
        });
    }

    // --- Initialisation au chargement de la page ---
    document.addEventListener('DOMContentLoaded', initializeEventListeners);

</script>
</body>
</html>
